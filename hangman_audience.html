<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Black Tie Gala - Hangman Audience</title>
    <script>
      window.FIREBASE_CONFIG = {
        apiKey: "",
        authDomain: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: "",
      };
      window.EVENT_ID = "black-tie-gala-2026-02-09";
    </script>
    <style>
      :root {
        --bg-1: #0b0d12;
        --bg-2: #161b24;
        --bg-3: #0f141c;
        --gold-1: #f6d67b;
        --gold-2: #c9a44d;
        --ink: #e9eef6;
        --muted: #a6b3c6;
        --host: #ff8a5b;
        --aud: #5fd6a6;
        --card: rgba(17, 20, 28, 0.85);
        --stroke: rgba(255, 255, 255, 0.08);
        --shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--ink);
        font-family: "Fraunces", "Iowan Old Style", "Palatino Linotype",
          "Book Antiqua", "Times New Roman", serif;
        background:
          radial-gradient(1200px 600px at 80% -20%, rgba(246, 214, 123, 0.12), transparent 60%),
          radial-gradient(800px 500px at 10% 10%, rgba(255, 138, 91, 0.12), transparent 60%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2) 40%, var(--bg-3));
        min-height: 100vh;
      }

      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 18px 40px;
      }

      header {
        text-align: center;
        margin-bottom: 16px;
      }

      header h1 {
        margin: 0 0 6px;
        font-size: clamp(1.8rem, 5vw, 2.6rem);
        letter-spacing: 0.04em;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-family: "Work Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        font-size: 0.95rem;
      }

      .glass {
        background: var(--card);
        border: 1px solid var(--stroke);
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding: 16px;
        backdrop-filter: blur(10px);
      }

      .bar {
        display: grid;
        gap: 10px;
        margin-bottom: 16px;
      }

      .track {
        position: relative;
        height: 16px;
        border-radius: 999px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.08);
      }

      .meter {
        position: absolute;
        inset: 0;
        width: 0%;
      }

      .meter.host {
        background: linear-gradient(120deg, var(--host), #ffb18b);
      }

      .meter.aud {
        background: linear-gradient(120deg, var(--aud), #93e7c4);
        mix-blend-mode: screen;
      }

      .bar-labels {
        display: flex;
        justify-content: space-between;
        font-family: "Work Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .board {
        display: grid;
        gap: 12px;
      }

      .phrase {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
      }

      .tile {
        min-width: 28px;
        height: 38px;
        border-radius: 8px;
        border: 1px solid var(--stroke);
        display: grid;
        place-items: center;
        font-size: 1.1rem;
        background: rgba(255, 255, 255, 0.04);
      }

      .tile.blank {
        color: transparent;
      }

      .tile.space {
        border: none;
        background: transparent;
        min-width: 10px;
      }

      .incorrect {
        border: 1px dashed rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        font-family: "Work Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      }

      .incorrect-title {
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 0.7rem;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .incorrect-list {
        font-size: 1rem;
      }

      .letters-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 8px;
      }

      .letters-grid button {
        border: 1px solid var(--stroke);
        border-radius: 10px;
        padding: 10px 0;
        background: rgba(255, 255, 255, 0.06);
        color: var(--ink);
        font-family: "Work Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        font-weight: 600;
        cursor: pointer;
      }

      .letters-grid button.used {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .status {
        text-align: center;
        color: var(--muted);
        font-family: "Work Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>Hangman</h1>
        <p>Vote letters when it is the audience turn.</p>
      </header>

      <section class="bar glass">
        <div class="bar-labels">
          <span>Contestants: <strong id="host-score">0%</strong></span>
          <span>Audience: <strong id="aud-score">0%</strong></span>
        </div>
        <div class="track">
          <div class="meter host" id="host-meter"></div>
          <div class="meter aud" id="aud-meter"></div>
        </div>
      </section>

      <section class="board glass">
        <div class="phrase" id="phrase-board"></div>
        <div class="incorrect">
          <div class="incorrect-title">Incorrect Letters</div>
          <div class="incorrect-list" id="incorrect-list">None</div>
        </div>
        <div class="letters-grid" id="audience-letters"></div>
        <div class="status" id="vote-status">Waiting for the host.</div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        runTransaction,
        collection,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

      const firebaseConfig = window.FIREBASE_CONFIG || null;
      const eventId = window.EVENT_ID || "black-tie-gala";
      const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
      const PRELOAD_PHRASE = "BLACK TIE GALA";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const stateRef = doc(db, "events", eventId, "hangman", "state");
      const votesRef = collection(db, "events", eventId, "hangman_votes");

      const hostMeter = document.getElementById("host-meter");
      const audMeter = document.getElementById("aud-meter");
      const hostScore = document.getElementById("host-score");
      const audScore = document.getElementById("aud-score");
      const phraseBoard = document.getElementById("phrase-board");
      const incorrectList = document.getElementById("incorrect-list");
      const lettersGrid = document.getElementById("audience-letters");
      const voteStatus = document.getElementById("vote-status");

      const localVote = JSON.parse(localStorage.getItem("hangmanVote") || "{}");

      const buildBoard = (phrase, revealedLetters) => {
        phraseBoard.innerHTML = "";
        const upper = phrase.toUpperCase();
        for (const ch of upper) {
          if (ch === " ") {
            const tile = document.createElement("div");
            tile.className = "tile space";
            phraseBoard.appendChild(tile);
            continue;
          }
          const tile = document.createElement("div");
          tile.className = "tile";
          if (/[A-Z]/.test(ch)) {
            if (!revealedLetters.has(ch)) tile.classList.add("blank");
            tile.textContent = ch;
          } else {
            tile.textContent = ch;
          }
          phraseBoard.appendChild(tile);
        }
      };

      const countLetters = (phrase) => {
        return (phrase.match(/[A-Z]/gi) || []).length;
      };

      const ensureState = async () => {
        const totalLetters = countLetters(PRELOAD_PHRASE);
        await setDoc(
          stateRef,
          {
            phrase: PRELOAD_PHRASE,
            revealedLetters: [],
            incorrectLetters: [],
            hostFound: 0,
            audienceFound: 0,
            totalLetters,
            currentTurn: "audience",
            audienceRound: 1,
            lastAppliedRound: 0,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
      };

      await ensureState();

      const renderLetters = (usedLetters, isAudienceTurn, round) => {
        lettersGrid.innerHTML = "";
        alphabet.forEach((letter) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = letter;
          const alreadyVoted = localVote.round === round;
          if (usedLetters.has(letter) || !isAudienceTurn || alreadyVoted) {
            btn.classList.add("used");
          }
          btn.addEventListener("click", () => voteLetter(letter, round));
          lettersGrid.appendChild(btn);
        });
      };

      const voteLetter = async (letter, round) => {
        if (localVote.round === round) return;
        localVote.round = round;
        localVote.letter = letter;
        localStorage.setItem("hangmanVote", JSON.stringify(localVote));
        voteStatus.textContent = `Voted for ${letter}.`;
        await addDoc(votesRef, {
          letter,
          round,
          createdAt: serverTimestamp(),
          userAgent: navigator.userAgent,
        });
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(stateRef);
          const data = snap.data() || {};
          const current = data.audienceFound || 0;
          tx.set(stateRef, { audienceFound: current }, { merge: true });
        });
      };

      onSnapshot(stateRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        const phrase = data.phrase || PRELOAD_PHRASE;
        const revealed = new Set(data.revealedLetters || []);
        const incorrect = new Set(data.incorrectLetters || []);
        const usedLetters = new Set([...revealed, ...incorrect]);
        buildBoard(phrase, revealed);
        incorrectList.textContent =
          incorrect.size > 0 ? [...incorrect].sort().join(" ") : "None";
        const total = data.totalLetters || countLetters(phrase);
        const hostPct = total ? Math.round(((data.hostFound || 0) / total) * 100) : 0;
        const audPct = total ? Math.round(((data.audienceFound || 0) / total) * 100) : 0;
        hostMeter.style.width = `${hostPct}%`;
        audMeter.style.width = `${audPct}%`;
        hostScore.textContent = `${hostPct}%`;
        audScore.textContent = `${audPct}%`;

        const isAudienceTurn = (data.currentTurn || "audience") === "audience";
        const round = data.audienceRound || 1;
        renderLetters(usedLetters, isAudienceTurn, round);
        voteStatus.textContent = isAudienceTurn
          ? "Audience turn: vote a letter."
          : "Contestants turn. Wait for the host.";
      });
    </script>
  </body>
</html>
